<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Start VNC Browsing Agent (Vercel)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #streamOutput { white-space: pre-line; border:1px solid #ccc; padding:10px; height:300px; overflow-y:auto; }
  button { padding:10px 20px; font-size:16px; }
  textarea { width:100%; padding:8px; margin:10px 0; }
</style>
</head>
<body>
  <h1>Start VNC Browsing Agent (Vercel)</h1>
  <form id="taskForm">
    <label for="task">Enter task description:</label>
    <textarea id="task" name="task" rows="4" placeholder="Describe the browsing task..."></textarea>
    <button type="submit">Start Session & Stream</button>
  </form>

  <div id="vncButtonContainer" style="margin-top:20px;"></div>
  <div id="streamOutput"></div>

<script>
const vercelAgentUrl = 'https://vercel-agents.vercel.app/browser_agent';
const albDomain = 'cuak-v1-stickiness-balancer-871735130.us-east-1.elb.amazonaws.com/'; // Replace with THE ALB domain

document.getElementById('taskForm').addEventListener('submit', async e => {
  e.preventDefault();
  document.getElementById('vncButtonContainer').innerHTML = '';
  document.getElementById('streamOutput').textContent = 'Starting session...\n';

  const response = await fetch(vercelAgentUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',  // ⬅️ IMPORTANT: Ensures cookies are stored!
        body: JSON.stringify({ protocol: 'data', task: document.getElementById('task').value, user_context: '' })
    });


  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let bufferedLine = '', stickinessValue = null, capturedVncUrl = null;

  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value);
    document.getElementById('streamOutput').textContent += chunk;
    document.getElementById('streamOutput').scrollTop = document.getElementById('streamOutput').scrollHeight;

    bufferedLine += chunk;
    let lines = bufferedLine.split('\n');
    bufferedLine = lines.pop();

    lines.forEach(line => {
      if (line.includes('SESSION_STICKINESS:')) {
        stickinessValue = line.split('SESSION_STICKINESS:')[1].trim();
        localStorage.setItem('sessionStickiness', stickinessValue);
      }
      if (line.includes('VNC_URL:')) {
        capturedVncUrl = line.split('VNC_URL:')[1].trim();
        const redirectUrl = `redirect.html?vnc_url=${encodeURIComponent(capturedVncUrl)}&session_stickiness=${stickinessValue}&alb_domain=${albDomain}`;
        document.getElementById('vncButtonContainer').innerHTML =
          `<iframe src="${redirectUrl}" width="100%" height="700px" frameborder="0"></iframe>`;
      }
    });
  }
})();
</script>
</body>
</html>





